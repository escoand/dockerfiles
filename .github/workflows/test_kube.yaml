on: push
jobs:
  test-commit:
    name: Test commit
    runs-on: ubuntu-24.04
    steps:
      # setup
      - name: Install deps
        run: |-
          set -euo pipefail
          sudo apt-get update -qy
          sudo apt-get install -y podman>=4.4
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Podman socket
        run: systemctl --user start podman.socket
      - name: Patch pods for testing
        run: |-
          set -euxo pipefail
          sed -i \
              -e '/^[[:blank:]]*env:/ {' \
              -e 'a\        - { name: NEXTCLOUD_ADMIN_USER, value: admin }' \
              -e 'a\        - { name: NEXTCLOUD_ADMIN_PASSWORD, value: admin }' \
              -e '}' \
              kube/nextcloud.yaml
          sed -i \
              -e "s|/run/user/1000/|${XDG_RUNTIME_DIR:-/run/user/1000}/|" \
              kube/*.yaml
      # startup
      - name: Create pods
        run: |-
          set -euo pipefail
          find init/ -name 'secrets.*.yaml' -exec podman kube play {} \;
          find kube/ -name '*.yaml' -exec podman kube play --quiet --start=false {} \;
      - name: Create databases
        run: |-
          set -euo pipefail
          podman pod start mariadb
          podman wait --condition healthy mariadb-mariadb
          ./db_usr_pwd.sh MYSQL nextcloud
          ./db_usr_pwd.sh WORDPRESS_DB wordpress1
          ./db_usr_pwd.sh WORDPRESS_DB wordpress2
      - name: Start pods
        run: podman pod start -a
      - name: Wait for healthy state
        run: |-
          set -euo pipefail
          yq -ot '. as $parent | (
            .spec.containers[] | select(.livenessProbe) | $parent.metadata.name + "-" + .name,
            .spec.template.spec.containers[] | select(.livenessProbe) | $parent.metadata.name + "-pod-" + .name
          )' kube/*.yaml |
          xargs -t podman wait --condition healthy
        timeout-minutes: 2
      # testing
      - name: Test Dozzle
        run: |-
          set -euxo pipefail
          USER_=$(podman secret inspect caddy --showsecret --format "{{.SecretData}}" | yq -ot .data.dozzle_user | base64 -d)
          DOMAIN=$(podman secret inspect caddy --showsecret --format "{{.SecretData}}" | yq -ot .data.nextcloud_domain | base64 -d)
          curl -ikLsS --location-trusted --user "$USER_:$USER_" \
            --connect-to "$DOMAIN:80:127.0.0.1:8080" \
            --connect-to "$DOMAIN:443:127.0.0.1:8443" \
            "http://$DOMAIN/dozzle/" |
            grep -q "^HTTP/[1-9\.]* 200"
      - name: Test Nextcloud
        run: |-
          set -euxo pipefail
          DOMAIN=$(podman secret inspect caddy --showsecret --format "{{.SecretData}}" | yq -ot .data.nextcloud_domain | base64 -d)
          curl -ikLsS \
            --connect-to "$DOMAIN:80:127.0.0.1:8080" \
            --connect-to "$DOMAIN:443:127.0.0.1:8443" \
            "http://$DOMAIN/status.php" |
            tee /dev/stderr |
            grep -q '"installed":true'
      - name: Test Redirection
        run: |-
          set -euxo pipefail
          DOMAIN=$(podman secret inspect caddy --showsecret --format "{{.SecretData}}" | yq -ot .data.redir_domain | base64 -d)
          TARGET=$(podman secret inspect caddy --showsecret --format "{{.SecretData}}" | yq -ot .data.redir_target | base64 -d)
          {
            curl -ikLsS --max-redirs 1 \
            --connect-to "$DOMAIN:80:127.0.0.1:8080" \
            --connect-to "$DOMAIN:443:127.0.0.1:8443" \
            "http://$DOMAIN/test.php" || [ $? = 47 ]
          } |
            grep -q "Location: $TARGET"
      - name: Test Wordpress
        run: |-
          set -euxo pipefail
          DOMAIN=$(podman secret inspect caddy --showsecret --format "{{.SecretData}}" | yq -ot .data.wordpress1_domain | base64 -d)
          curl -ikLsS \
            --connect-to "$DOMAIN:80:127.0.0.1:8080" \
            --connect-to "$DOMAIN:443:127.0.0.1:8443" \
            "http://$DOMAIN/wp-admin/install.php" |
            grep -q "^HTTP/[1-9\.]* 200"
      # state if failed
      - name: State pods
        if: ${{ failure() }}
        run: podman pod ls
      - name: State containers
        if: ${{ failure() }}
        run: podman ps -a
      - name: Container logs
        if: ${{ failure() }}
        run: |-
          set -euo pipefail
          yq -ot '. as $parent | (
            .spec.containers[] | $parent.metadata.name + "-" + .name,
            .spec.template.spec.containers[] | $parent.metadata.name + "-pod-" + .name
          )' kube/*.yaml |
          xargs -t podman logs -n
