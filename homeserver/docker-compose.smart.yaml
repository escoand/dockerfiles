version: "2.4"
services:

  dnsmasq:
    container_name: dnsmasq
    image: andyshinn/dnsmasq
    restart: always
    ports:
      - 53:53/tcp
      - 53:53/udp
    cap_add:
      - NET_ADMIN
    command: >-
      --conf-dir=/config
      --no-hosts
      --no-resolv
    volumes:
      - ${DATA_DIR}/dnsmasq:/config:ro

  homeassistant:
    container_name: homeassistant
    image: homeassistant/home-assistant:stable
    restart: always
    network_mode: host
    volumes:
      - /etc/hosts:/host:ro
      - ${DATA_DIR}/homeassistant:/config
    labels:
      - traefik.enable=true
      - traefik.http.routers.homeassistant.rule=Host(`${DOMAIN_HOMEASSISTANT}`)
      - traefik.http.routers.homeassistant.tls=true
      - traefik.http.routers.homeassistant.tls.certresolver=default
      - traefik.http.services.homeassistant.loadbalancer.server.port=8123

  esphome:
    container_name: esphome
    image: esphome/esphome
    restart: always
    network_mode: host
    ports:
      - 6052:6052
    volumes:
      - ${DATA_DIR}/esphome:/config
    #devices:
      #- /dev/ttyUSB0

  grocy:
    container_name: grocy
    image: linuxserver/grocy
    restart: always
    volumes:
      - ${DATA_DIR}/grocy:/config/data
    labels:
      - traefik.enable=true
      - traefik.http.routers.grocy.rule=Host(`${DOMAIN_GROCY}`)
      - traefik.http.routers.grocy.tls=true
      - traefik.http.routers.grocy.tls.certresolver=default
      - traefik.http.services.grocy.loadbalancer.server.port=80

  deconz:
    container_name: deconz
    image: marthoc/deconz:stable
    restart: always
    network_mode: host
    devices:
      - /dev/ttyACM0
    environment:
      - DECONZ_DEVICE=/dev/ttyACM0
      - DECONZ_WEB_PORT=8080
      - DECONZ_WS_PORT=8443
      - TZ
    volumes:
      - ${DATA_DIR}/deconz:/root/.local/share/dresden-elektronik/deCONZ
